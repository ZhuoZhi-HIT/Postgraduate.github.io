---
title: Modeling and verification of four-rotor UAV flight control system
layout: post
categories: ''
tags: ''
img: Flight_control_model.PNG
---
## Introduce
In order to improve the reliability of low-cost quadrotor UAV flight control system, designed a flight control system and proposed a modeling method. In this method, Newton-Euler formula is involved to set up the kinematic equation. The Mahony filter is used for sensor data fusion and attitude algorithm. A cascade proportion integration differentiation controller with integral separation is designed to control the attitude. Experimental data are compared between the simulation model and the real platform.  The usability of the model is verified and the reliability of the real flight control system can be evaluated by the formulated model.
## The simulation model
The model is built by Simulink in Matlab. The model mainly includes three sub-models, the attitude control model, the motor dynamics model and the rigid body dynamics model. The following is a brief introduction to the algorithms and principles used.
### (1) Establishment of kinematic equation
The external forces and moments experienced by the quadrotor UAV include three items.

① The gravity. 

② Lift${F_i} (i=1, 2, 3, 4)$ generated by rotation of rotors.

③ Torsional${M_i} (i=1, 2, 3, 4)$produced by rotor rotation.

The linear motion equation is defined by 

$$
m\ddot r = \left[ \begin{array}{c}
0\\
0\\
 - mg
\end{array} \right] + Rt\left[ \begin{array}{c}
0\\
0\\
\sum {{F_i}} 
\end{array} \right]
$$


where $r$ is position vector, ${F_i}$ is rotation lift, $mg$ is the gravity, $Rt$ is rotation matrix. And angular motion equation is given by

$$
I\left[ \begin{array}{l}
{\dot p}\\
{\dot q}\\
{\dot r}
\end{array} \right]{\rm{ = }}\left[ \begin{array}{l}
{\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} L({F_2}{\rm{ - }}{F_4})\\
{\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} {\kern 1pt} L({F_3}{\rm{ - }}{F_1})\\
{M_1} - {M_2} + {M_3} - {M_4}
\end{array} \right] - \left[ \begin{array}{l}
p\\
q\\
r
\end{array} \right] \times I\left[ \begin{array}{l}
p\\
q\\
r
\end{array} \right],
$$

where $L$ is distance from the rotor centre to the mass centre of UAV,  $I$ is inertia matrix,  $p$ , $q$ and $r$ are components of triaxial angular velocity in the body coordinate system.
### (2) Mahony filter
Mahony filter is utilized as attitude algorithm. The core idea is based on predictive-correction, given as follows.

① The standard gravity vector in the space coordinate system is converted into the body coordinate system by the rotation matrix. The process is shown by

$$
\left[ {\begin{array}{*{20}{c}}
{vx}\\
{vy}\\
{vz}
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
{2(q2q2 + q3q3)}&{2(q1q2 + q0q3)}&{2(q1q3 - q0q2)}\\
{2(q1q2 - q0q3)}&{1 - 2(q1q1 + q3q3)}&{2(q2q3 + q0q1)}\\
{2(q1q3 + q0q2)}&{2(q2q3 + q0q1)}&{1 - 2(q1q1 + q2q2)}
\end{array}} \right] \times \left[ \begin{array}{l}
0\\
0\\
1
\end{array} \right] =
$$

$$
\left[ {\begin{array}{*{20}{c}}
{2(q1q3 - q0q2)}\\
{2(q2q3 + q0q1)}\\
{1 - 2(q1q1 + q2q2)}
\end{array}} \right]
$$

where  $[{v_x},{v_y},{v_z}]$ is the gravity vector. $[0,0,1]$ is the coefficient of the standard gravity vector. The  $q0$,  $q1$, $q2$ and $q3$  are used to form a quaternion. 

② The error of the two coordinate systems is achieved by cross multiplication, which is used to correct the gyroscope in Mahony filter, as given by

$$
\left[ \begin{array}{l}
ex\\
ey\\
ez
\end{array} \right] = \left[ \begin{array}{l}
ax\\
ay\\
az
\end{array} \right] \otimes \left[ \begin{array}{l}
vx\\
vy\\
vz
\end{array} \right] = \left[ {\begin{array}{*{20}{c}}
\begin{array}{l}
ay * vz - az * vy\\
az * vx - ax * vz
\end{array}\\
{ax * vy - az * vx}
\end{array}} \right]
$$

where  ${% raw %}\left[ {{a_x},{a_y},{a_z}} \right]{% endraw %}$ is the gravity vector measured by sensors, and  ${% raw %}\left[ {{e_x},{e_y},{e_z}} \right]{% endraw %}$ is the error vector of two coordinate systems.

③ The gyroscope is compensated and corrected by the error vector through a PI controller. The integral error of the gyroscope is the fundamental source of error in the body coordinate system. 
### (3) Cascade  PID controller
A double-loop cascade PID controller with integral separation. Take the ROL angle as an example, the diagram of control block is shown below ：

![1]({{site.baseurl}}/assets/img/PIDcontrol.PNG)


When the deviation is large, the integral term is cleared. When the deviation is small, the integral term is turned on, which can achieve rapid dynamic response and stable static control.
## Flight controller design( software & hardware)
### (1) Software design
All software functions are divided into several tasks, such as upper computer communication, sensor data reading and processing, attitude solution, attitude control, external input capture, etc.  Priorities are assigned to tasks. Timer interrupts are used as start flags for tasks. The flow chart of system software is shown blew：
![2]({{site.baseurl}}assets/img/software_design.PNG)

Several main tasks are analysed as follows.

① External input signal capture

The external capture function of STM32F103RCT6 is used to decode the remote control signal as the input signal to the control system.

② Upper computer communication

The Direct Memory Access (DMA) transmission mode is used for wireless communication. This method solves the problem that serial communication interferes with other task processes. It achieves high-speed data transmission and fast system control.

③ Attitude algorithm and attitude control

Mahony filter was used for attitude algorithm. First order complementary filter was utilized for height calculation. The final output of the attitude control is the motor control PWM amount, which contains five inputs, as shown below：
![3]({{site.baseurl}}/assets/img/OUTPUT.PNG)

### (2) Hardware design
The MCU in this system is STM32F103RCT6. The sensors used are MPU9250 attitude sensor (with built-in gyroscope, accelerometer, magnetometer)(later improved to Mpu6050 + Ak8975), SPL06 barometer. The block diagram of hardware design is shown below：

![4]({{site.baseurl}}/assets/img/Hardware_diagram.PNG)

The PCB diagram and the schematic diagram of the flight controller is shown below:


![pcb]({{site.baseurl}}/assets/img/pcb.PNG)

![yuanli]({{site.baseurl}}/assets/img/yuanli.PNG)

The drone is shown below：
![xuke]({{site.baseurl}}/assets/img/xuke.PNG)
#这里可以加上一个测试视频

## Experiment 
### (1) Hight control experiment
The test objective is to identify the effect of the variable height control. The height control instructions are shown below:
![gaoduzhilin]({{site.baseurl}}/assets/img/gaoduzhilin.PNG)

The height data measured in simulation model and real platform are shown below:

![gaoduduibi](C:\Users\Coronation\Desktop\Personal Website\Postgraduate.github.io\assets\img\gaoduduibi.PNG)

The curve of height data measured in real platform has the same trend as the curve of height data measured in simulation model. The correlation coefficient between two data sets is **0.9794**, which indicates a strong relationship.
### (2) Dynamic attitude control experiment

The test objective is to study the overshoot, response speed and regression error. The desired angle input is set randomly. The angle data measured in simulation model and real platform are shown below:

![duibi1]({{site.baseurl}}/assets/img/duibi1.PNG)

![duibi2]({{site.baseurl}}/assets/img/duibi2.PNG)

Experimental data of real platform can follow the simulated waveforms well, and no runaway or oscillation occurs. Due to sensor noise and unavoidable environmental factors, there are small glitches in the measured data. The control system is accompanied with overshoot, which does not exceed 1 degree.
The regression error does not exceed 1 degree in the end of each instruction cycle. And the delay of controller response is less than 10ms. The correlation of three sets of comparative data are 0.9098, 0.9192, and 0.9688 respectively. Therefore, it can be considered that the output of simulation model and real platform in dynamic attitude control experiment is consistent.







